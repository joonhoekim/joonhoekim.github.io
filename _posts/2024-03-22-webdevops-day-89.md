---
title: (Day	89) 
author: 김준회
date: 2024-03-22 16:00:00 +0900
categories: [TIL, 비트캠프]
tags: [TIL, Web, 비트캠프, 네이버클라우드]
pin: true
math: true
mermaid: true
image:
  path: data:image/png;base64,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
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
  alt: TIL image
---

[PDF](https://github.com/eomjinyoung/bitcamp-study/blob/main/docs/%EC%8A%A4%ED%94%84%EB%A7%81%ED%94%84%EB%A0%88%EC%9E%84%EC%9B%8C%ED%81%AC1.pdf)


# MyBatis

```java
  @Override
  public void add(Member member) { //매번 세션 받아야 한다.. 커넥션을 공유하지 않도록 하기 위함이다. 내부적으로 DB커넥션풀을 쓴다. mybatis-config.xml 을 보면 <dataSource type="POOLED"> 라는 부분이 있다. 같은 스레드는 같은 커넥션을 계속 쓴다는 것이다. 이 말은 트랜잭션을 구현하기 위해 커넥션을 공유하는 방법이 이미 적용되어 있다는 것이다. (물론 그럴 일은 없겠지만 이 프로그램을 단 한사람만 사용 하는 경우라면 클라를 구분하기 위해 매번 세션을 받지 않아도 된다.) 커밋/롤백 이전까지 같은 클라는 openSession() 에서 받은 같은 세션을 쓸 것이다.
    try (SqlSession sqlSession = sqlSessionFactory.openSession()) {
      sqlSession.insert("MemberDao.add", member);
    } //catch 하지 않아도 된다. 예외 발생시 컨트롤러가 받고 예외페이지를 클라에게 줄 것이다. try를 쓰는 것은 try-with-resource 문법을 써서 자원 할당/해제를 편하게 쓰려는 것이다.
  }
```

## SqlSession, Connection, Transaction
### Transaction 을 시작하지 않았을 때
트랜잭션을 시작하지 않았을 때
* openSession() 메서드를 호출해 DataSource에서 Connection 을 받을 것이다.
* SqlSession은 각각의 Connection을 받을 것이다.
* SqlSession이 close() 로 반환하면, 그 세션이 가지고 있던 커넥션이 DataSource에 반납될 것이다.

트랜잭션을 시작했을 때
* **SqlSession이 close() 로 반환해도, 그 세션이 가지고 있던 커넥션은 반납되지 않는다.!**
* 해당 스레드의 작업이 종료되었을 때, 그 세션이 가지고 있던 커넥션을 반납한다.

![](../assets/img/2024-03-22-10-18-48.png)

## 가능하면 MyBatis 애너테이션 문법 사용을 줄이자
원래 목적이 sql문과 java코드를 분리하는 것이었으므로..

## 동적 SQL (Dynamic SQL)
MyBatis에서도 조건에 따라 SQL문을 다이나믹하게 구성할 수 있도록 지원한다. MyBatis는 JSTL의 영향을 많이 받았다고 한다.

```java
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--하나의 DAO를 위해서 매퍼를 작성하고, 그 DAO의 인터페이스 이름과 일치시켜 어떤 DAO를 위한 것인지 바로 알아볼 수 있게 하자
    그리고 id를 메서드 이름과 일치시켜 그 DAO의 어떤 메서드가 해당 SQL문을 사용하는지 바로 알 수 있게 하자.-->
<mapper namespace="MemberDao">
  <insert id="add" parameterType="bitcamp.myapp.vo.Member">
    insert into members(email,name,password,photo)
    values(#{email}, #{name}, sha2(#{password},256),#{photo})

  </insert>

  <delete id="delete" parameterType="int">
    delete from members where member_no=#{value}
    <!--원시값(오토박싱), 스트링은 단 한개의 파라미터가 오는 경우 이름 마음대로 적어도 됨
        일반적으로는 value 라고 적음. number라고 적는 경우도 있음-->
  </delete>

  <select id="findAll" resultType="bitcamp.myapp.vo.Member">
    SELECT
    member_no as no,
    email,
    name,
    photo,
    created_date as createdDate
    FROM
    members
  </select>

  <select id="findBy" resultType="bitcamp.myapp.vo.Member" parameterType="int">
    SELECT member_no as no,
    email,
    name,
    photo,
    created_date as createdDate
    FROM members
    where member_no=#{no}
  </select>


  <update id="update" parameterType="bitcamp.myapp.vo.Member">
    UPDATE members
    SET
    email=#{email},
    name=#{name},
    photo=#{photo}
    <if test="password != ''"> <!-- Dynamic SQL !! -->
      , password=sha2(#{password}, 256)
    </if>
    WHERE member_no=#{no}
  </update>

  <select id="findByEmailAndPassword" resultType="bitcamp.myapp.vo.Member" parameterType="int">
    SELECT member_no as no,
    email,
    name,
    created_date as createdDate
    FROM members
    WHERE
    email=#{email} AND password=sha2(#{password},256)


  </select>
iu
</mapper>
```

# resultMap을 설정하는 이유
VO 필드와 DB 컬럼 이름의 차이를 해소하기 위해 별명을 따로 부여할 필요가 없음.

한번 resultMap을 잡아주면 type을 설정하기 위해 매번 FQName을 작성하지 않아도 됨
* FQName이 변경되면 resultMap 에서 한번만 변경해주면 됨
* 만약 resultMap에 담지 않았더라면 모든 코드에서 다 변경해줘야 함

## 더 편하게 하는 방법
`mybatis-config.xml`에서 패키지 내 모든 클래스에 대해서 별명을 자동부여할 수 있다. 

```xml
  <typeAliases>
    <package name="bitcamp.myapp.vo"/>
  </typeAliases>
```

이렇게하면 FQName을 적지 않고 클래스 이름만 적어도 자동 부여된 별명으로 잡혀서 클래스를 잡는다. 동일한 이름을 갖는 클래스가 많다면 주의해야 한다. 다만 그 중에서 한 패키지만 쓰는 경우라면 이 설정으로 유지보수를 더 편하게 할 수 있을 것이다.